name: Update Website Release Info

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  update-release-info:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get latest release info from crispy repo
        id: release
        run: |
          # Try to fetch latest release first
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/sleep3r/crispy/releases/latest")
          
          # Check if latest release exists, if not get the first release from all releases
          if echo "$RELEASE_DATA" | jq -e '.message' > /dev/null 2>&1; then
            echo "No 'latest' release found, fetching all releases..."
            RELEASE_DATA=$(curl -s "https://api.github.com/repos/sleep3r/crispy/releases" | jq '.[0]')
          fi
          
          # Extract release info
          RELEASE_TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name // "unknown"')
          RELEASE_NAME=$(echo "$RELEASE_DATA" | jq -r '.name // .tag_name // "unknown"')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at // ""')
          HTML_URL=$(echo "$RELEASE_DATA" | jq -r '.html_url // ""')
          
          # Get download URLs for assets
          ASSETS=$(echo "$RELEASE_DATA" | jq '.assets // [] | map({name: .name, browser_download_url: .browser_download_url})')
          
          # Create JSON with release info
          cat > release-info.json <<EOF
          {
            "version": "$RELEASE_TAG",
            "name": "$RELEASE_NAME",
            "published_at": "$PUBLISHED_AT",
            "html_url": "$HTML_URL",
            "assets": $ASSETS
          }
          EOF
          
          echo "Release version: $RELEASE_TAG"
          echo "Assets count: $(echo "$ASSETS" | jq 'length')"
          cat release-info.json

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add release-info.json
          if ! git diff --quiet --cached; then
            RELEASE_TAG=$(jq -r '.version' release-info.json)
            git commit -m "Update release info to $RELEASE_TAG"
            git push
          else
            echo "No changes to commit"
          fi
